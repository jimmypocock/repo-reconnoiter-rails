post:
  summary: Create comparison (async)
  description: |
    Creates a new repository comparison asynchronously. Returns immediately with a session ID
    that can be used to track progress via WebSocket or polling.

    **Authentication:** Required
    - API key: `Authorization: Bearer <API_KEY>` header
    - User JWT: `X-User-Token: <JWT>` header

    **Real-time Progress:** Two methods available
    1. **WebSocket** (recommended): Subscribe to ComparisonStatusChannel with session_id
    2. **REST Polling** (fallback): Poll GET /comparisons/status/:session_id

    **Rate Limiting:** 25 comparisons/day per user
  operationId: createComparison
  tags:
    - Comparisons
  security:
    - BearerAuth: []
  requestBody:
    required: true
    content:
      application/json:
        schema:
          type: object
          required:
            - query
          properties:
            query:
              type: string
              description: Natural language query describing repository needs
              minLength: 1
              maxLength: 500
              example: "Rails background job library with retry logic"
        example:
          query: "Rails background job library with retry logic"
  responses:
    '202':
      description: Accepted - Comparison creation started
      content:
        application/json:
          schema:
            type: object
            required:
              - session_id
              - status
              - websocket_url
              - status_url
            properties:
              session_id:
                type: string
                format: uuid
                description: Unique session ID for tracking progress
                example: "550e8400-e29b-41d4-a716-446655440000"
              status:
                type: string
                enum: [processing]
                description: Current status (always "processing" on creation)
                example: "processing"
              websocket_url:
                type: string
                format: uri
                description: WebSocket URL for real-time progress updates
                example: "wss://api.reporeconnoiter.com/cable"
              status_url:
                type: string
                format: uri
                description: REST endpoint for polling status
                example: "/api/v1/comparisons/status/550e8400-e29b-41d4-a716-446655440000"
          example:
            session_id: "550e8400-e29b-41d4-a716-446655440000"
            status: "processing"
            websocket_url: "wss://api.reporeconnoiter.com/cable"
            status_url: "/api/v1/comparisons/status/550e8400-e29b-41d4-a716-446655440000"
    '400':
      description: Bad request (invalid query)
      content:
        application/json:
          schema:
            $ref: '../schemas/Error.yml'
          example:
            error:
              message: "Invalid query"
              details: ["Query must be between 1 and 500 characters"]
    '401':
      description: Unauthorized (missing or invalid authentication)
      content:
        application/json:
          schema:
            $ref: '../schemas/Error.yml'
          examples:
            missing_api_key:
              summary: Missing API key
              value:
                error:
                  message: "API key required"
                  details: ["Missing Authorization header"]
            missing_user_token:
              summary: Missing user JWT
              value:
                error:
                  message: "User authentication required"
                  details: ["Missing X-User-Token header"]
    '429':
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '../schemas/Error.yml'
          example:
            error:
              message: "Rate limit exceeded"
              details: ["You've created 25 comparisons today. Try again tomorrow."]

get:
  summary: List comparisons
  description: |
    Returns a paginated list of repository comparisons with optional filtering and search.

    Supports fuzzy search across query text, technologies, problem domains, and categories.

    **Authentication:** Required - API key via `Authorization: Bearer <API_KEY>` header

    **Rate Limiting:** None (API key authentication bypasses Rack::Attack rate limits)
  operationId: listComparisons
  tags:
    - Comparisons
  security:
    - BearerAuth: []
  parameters:
    - name: search
      in: query
      description: Fuzzy search term (searches across query, technologies, domains, categories)
      required: false
      schema:
        type: string
        example: "rails background job"
    - name: date
      in: query
      description: Filter by date range
      required: false
      schema:
        type: string
        enum: [week, month]
        example: "week"
    - name: sort
      in: query
      description: Sort order (ignored when searching - uses relevance instead)
      required: false
      schema:
        type: string
        enum: [recent, popular]
        default: recent
    - name: page
      in: query
      description: Page number for pagination
      required: false
      schema:
        type: integer
        minimum: 1
        default: 1
        example: 1
    - name: per_page
      in: query
      description: Items per page (max 100)
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
        example: 20
  responses:
    '200':
      description: Successful response
      content:
        application/json:
          schema:
            type: object
            properties:
              data:
                type: array
                items:
                  $ref: '../schemas/Comparison.yml'
              meta:
                $ref: '../schemas/PaginationMeta.yml'
          example:
            data:
              - id: 1
                user_query: "Rails background job library with retry logic"
                normalized_query: "rails background job library with retry logic"
                technologies: "Rails, Ruby"
                problem_domains: "Background Job Processing"
                architecture_patterns: null
                repos_compared_count: 3
                recommended_repo: "sidekiq/sidekiq"
                view_count: 42
                created_at: "2025-01-15T10:30:00Z"
                updated_at: "2025-01-15T10:30:00Z"
                categories:
                  - id: 5
                    name: "Ruby"
                    category_type: "language"
                  - id: 12
                    name: "Background Jobs"
                    category_type: "problem_domain"
                repositories:
                  - id: 123
                    full_name: "sidekiq/sidekiq"
                    description: "Simple, efficient background processing for Ruby"
                    stargazers_count: 13000
                    language: "Ruby"
                    html_url: "https://github.com/sidekiq/sidekiq"
            meta:
              pagination:
                page: 1
                per_page: 20
                total_pages: 5
                total_count: 95
                next_page: 2
                prev_page: null
    '400':
      description: Bad request (invalid parameters)
      content:
        application/json:
          schema:
            $ref: '../schemas/Error.yml'
          example:
            error:
              message: "Invalid request parameters"
              details: ["per_page must be between 1 and 100"]
    '401':
      description: Unauthorized (missing or invalid API key)
      content:
        application/json:
          schema:
            $ref: '../schemas/Error.yml'
          examples:
            missing_auth:
              summary: Missing Authorization header
              value:
                error:
                  message: "API key required"
                  details: ["Missing Authorization header. Expected format: 'Authorization: Bearer <API_KEY>'"]
            invalid_auth:
              summary: Invalid or revoked API key
              value:
                error:
                  message: "Invalid API key"
                  details: ["The provided API key is invalid or has been revoked"]
    '429':
      description: Rate limit exceeded (too many requests)
      headers:
        Retry-After:
          description: Number of seconds to wait before retrying
          schema:
            type: integer
            example: 3456
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                properties:
                  message:
                    type: string
                    description: Human-readable error message
                  retry_after:
                    type: integer
                    description: Seconds until rate limit resets
          example:
            error:
              message: "API rate limit exceeded. Try again later."
              retry_after: 3456
    '500':
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '../schemas/Error.yml'
